services:
  # =============================================================================
  # MESH ROUTER TUNNEL
  # Establishes WireGuard VPN tunnel to the provider for NAT traversal
  # =============================================================================
  mesh-router:
    image: ghcr.io/yundera/mesh-router-tunnel:latest
    container_name: mesh-router
    hostname: mesh-router
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      - PROVIDER=${PROVIDER}
      - BACKEND_URL=${BACKEND_URL}
      - ROUTING_TARGET_HOST=caddy
      - ROUTING_TARGET_PORT=80
    networks:
      - pcs
    depends_on:
      - caddy

  # =============================================================================
  # MESH ROUTER AGENT
  # Registers public IP with backend for direct routing (bypasses VPN)
  # =============================================================================
  mesh-router-agent:
    image: ghcr.io/yundera/mesh-router-agent:latest
    container_name: mesh-router-agent
    hostname: mesh-router-agent
    restart: unless-stopped
    environment:
      - PROVIDER=${PROVIDER}
      - PUBLIC_IP=${PUBLIC_IP}
      - TARGET_PORT=10443
    networks:
      - pcs

  # =============================================================================
  # CADDY
  # Reverse proxy for local traffic routing
  # =============================================================================
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    hostname: caddy
    restart: unless-stopped
    ports:
      - "10443:10443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - pcs

  # =============================================================================
  # CASAOS (Optional)
  # Container management UI - remove if not needed
  # =============================================================================
  casaos:
    image: ghcr.io/yundera/casa-img:latest
    container_name: casaos
    hostname: casaos
    restart: unless-stopped
    environment:
      DOCKER_API_VERSION: "1.44"
      PUID: "1000"
      PGID: "1000"
      DATA_ROOT: "${PCS_DATA_ROOT:-/DATA}"
      REF_DOMAIN: "${PCS_DOMAIN}"
      REF_NET: "pcs"
      REF_PORT: "443"
      REF_SCHEME: "https"
      default_pwd: "${PCS_DEFAULT_PASSWORD}"
      public_ip: "${PUBLIC_IP}"
      domain: "${PCS_DOMAIN}"
      PCS_DEFAULT_PASSWORD: "${PCS_DEFAULT_PASSWORD}"
      PCS_DOMAIN: "${PCS_DOMAIN}"
      PCS_DATA_ROOT: "${PCS_DATA_ROOT:-/DATA}"
      PCS_PUBLIC_IP: "${PUBLIC_IP}"
      PCS_EMAIL: "${PCS_EMAIL}"
    networks:
      - pcs
    volumes:
      - type: bind
        source: ${DATA_HOST_PATH:-/DATA}
        target: /DATA
        bind:
          propagation: rshared
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: /dev
        target: /dev

networks:
  pcs:
    driver: bridge
    name: pcs

volumes:
  caddy_data:
  caddy_config:
