services:
  # =============================================================================
  # MESH ROUTER TUNNEL
  # Establishes WireGuard VPN tunnel to the provider for NAT traversal
  # =============================================================================
  mesh-router-tunnel:
    image: mesh-router-tunnel:local
    container_name: mesh-router-tunnel
    hostname: mesh-router-tunnel
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      - PROVIDER=${PROVIDER}
      - ROUTING_TARGET_HOST=caddy
      - ROUTING_TARGET_PORT=80
    networks:
      - mesh
    depends_on:
      - caddy

  # =============================================================================
  # MESH ROUTER AGENT
  # Registers public IP with backend for direct routing (bypasses VPN)
  # =============================================================================
  mesh-router-agent:
    image: mesh-router-agent:local
    container_name: mesh-router-agent
    hostname: mesh-router-agent
    restart: unless-stopped
    environment:
      - PROVIDER=${PROVIDER}
      - PUBLIC_IP=${PUBLIC_IP}
      - TARGET_PORT=10443
    volumes:
      - agent-data:/app/data
    networks:
      - mesh

  # =============================================================================
  # CADDY
  # Reverse proxy with Docker container discovery via labels
  # =============================================================================
  caddy:
    image: lucaslorentz/caddy-docker-proxy:ci-alpine
    container_name: caddy
    hostname: caddy
    restart: unless-stopped
    ports:
      - "80:80"      # ACME HTTP-01 challenges for Let's Encrypt
      - "10443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - agent-data:/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - CADDY_DOCKER_CADDYFILE_PATH=/etc/caddy/Caddyfile
      - CADDY_INGRESS_NETWORKS=mesh
      - PCS_EMAIL=${PCS_EMAIL}  # For ACME/Let's Encrypt registration
    networks:
      - mesh
    depends_on:
      - mesh-router-agent

  # =============================================================================
  # CASAOS (Optional)
  # Container management UI - remove if not needed
  # =============================================================================
  casaos:
    image: ghcr.io/yundera/casa-img:latest
    container_name: casaos
    hostname: casaos
    restart: unless-stopped
    labels:
      # Caddy routing labels (Compass-compatible)
      # TLS uses on-demand Let's Encrypt from global Caddyfile config
      - "caddy=${PCS_DOMAIN}"
      - "caddy.reverse_proxy={{upstreams 8080}}"
    environment:
      DOCKER_API_VERSION: "1.44"
      PUID: "1000"
      PGID: "1000"
      DATA_ROOT: "${PCS_DATA_ROOT:-/DATA}"
      REF_DOMAIN: "${PCS_DOMAIN}"
      REF_NET: "mesh"
      REF_PORT: "80"
      REF_SCHEME: "http"
      default_pwd: "${PCS_DEFAULT_PASSWORD}"
      public_ip: "${PUBLIC_IP}"
      domain: "${PCS_DOMAIN}"
      PCS_DEFAULT_PASSWORD: "${PCS_DEFAULT_PASSWORD}"
      PCS_DOMAIN: "${PCS_DOMAIN}"
      PCS_DATA_ROOT: "${PCS_DATA_ROOT:-/DATA}"
      PCS_PUBLIC_IP: "${PUBLIC_IP}"
      PCS_EMAIL: "${PCS_EMAIL}"
    networks:
      - mesh
    volumes:
      - type: bind
        source: ${DATA_HOST_PATH:-/DATA}
        target: /DATA
        bind:
          propagation: rshared
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: /dev
        target: /dev

networks:
  mesh:
    driver: bridge
    name: mesh

volumes:
  agent-data:
  caddy_data:
  caddy_config:
